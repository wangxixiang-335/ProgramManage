# ğŸ”§ news-images å­˜å‚¨æ¡¶æ•…éšœæ’é™¤æŒ‡å—

## â“ é—®é¢˜ï¼šä¸Šä¼ å›¾ç‰‡æ—¶æ— æ³•è®¿é—® news-images æ¡¶

### ğŸš¨ å¿«é€Ÿè§£å†³æ–¹æ¡ˆ

#### 1. æ‰§è¡Œä¿®å¤SQLè¯­å¥
åœ¨ Supabase Dashboard çš„ SQL ç¼–è¾‘å™¨ä¸­æ‰§è¡Œ `fix-storage-access.sql` æ–‡ä»¶ä¸­çš„SQLè¯­å¥ã€‚

#### 2. è¿è¡Œè°ƒè¯•å·¥å…·
åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
debugNewsStorage()
```

---

## ğŸ” è¯¦ç»†è¯Šæ–­æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å­˜å‚¨æ¡¶æ˜¯å¦å­˜åœ¨
```sql
SELECT * FROM storage.buckets WHERE name = 'news-images';
```

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥å­˜å‚¨ç­–ç•¥
```sql
SELECT * FROM storage.policies WHERE bucket_id = 'news-images';
```

### ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥ç”¨æˆ·æƒé™
åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€
supabase.auth.getSession().then(console.log)
```

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: "Bucket not found" é”™è¯¯

**ç—‡çŠ¶**: ä¸Šä¼ æ—¶æç¤ºå­˜å‚¨æ¡¶ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- åˆ›å»ºå­˜å‚¨æ¡¶
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'news-images',
  'news-images',
  true,
  5242880,
  ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp']
);
```

### é—®é¢˜2: "Permission denied" é”™è¯¯

**ç—‡çŠ¶**: ä¸Šä¼ æ—¶æç¤ºæƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- è®¾ç½®ä¸Šä¼ ç­–ç•¥
CREATE POLICY "Authenticated Upload Access" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'news-images' AND 
  auth.role() = 'authenticated'
);
```

### é—®é¢˜3: "Policy violates definition" é”™è¯¯

**ç—‡çŠ¶**: ç­–ç•¥å†²çªæˆ–å®šä¹‰é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- åˆ é™¤æ‰€æœ‰ç°æœ‰ç­–ç•¥ï¼Œç„¶åé‡æ–°åˆ›å»º
DROP POLICY IF EXISTS "ç­–ç•¥åç§°" ON storage.objects;
```

### é—®é¢˜4: ç”¨æˆ·æœªç™»å½•

**ç—‡çŠ¶**: åŒ¿åç”¨æˆ·æ— æ³•ä¸Šä¼ æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
1. åœ¨åº”ç”¨ä¸­å®ç°ç™»å½•åŠŸèƒ½
2. æˆ–ä½¿ç”¨æœåŠ¡è§’è‰²å¯†é’¥ï¼ˆä»…é™åç«¯ä½¿ç”¨ï¼‰

---

## ğŸ”§ è°ƒè¯•å·¥å…·ä½¿ç”¨

### å†…ç½®è°ƒè¯•å‘½ä»¤
åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œï¼š

```javascript
// è¯Šæ–­å­˜å‚¨è®¿é—®
debugNewsStorage()

// è·å–ä¿®å¤å»ºè®®
getStorageFixSuggestions()

// æ£€æŸ¥å­˜å‚¨æ¡¶çŠ¶æ€
debugSupabaseStorage()
```

### æ‰‹åŠ¨æµ‹è¯•ä¸Šä¼ 
```javascript
// åˆ›å»ºæµ‹è¯•æ–‡ä»¶
const testBlob = new Blob(['test'], { type: 'text/plain' });
const testFile = new File([testBlob], 'test.txt');

// å°è¯•ä¸Šä¼ 
supabase.storage.from('news-images').upload('test.txt', testFile)
  .then(console.log)
  .catch(console.error);
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### âœ… å­˜å‚¨æ¡¶é…ç½®
- [ ] å­˜å‚¨æ¡¶ `news-images` å­˜åœ¨
- [ ] å­˜å‚¨æ¡¶è®¾ç½®ä¸ºå…¬å¼€è®¿é—® (`public = true`)
- [ ] æ–‡ä»¶å¤§å°é™åˆ¶åˆé€‚ï¼ˆæ¨è5MBï¼‰
- [ ] å…è®¸çš„MIMEç±»å‹åŒ…å«å›¾ç‰‡æ ¼å¼

### âœ… è®¿é—®ç­–ç•¥
- [ ] å…¬å¼€è¯»å–ç­–ç•¥å·²è®¾ç½®
- [ ] è®¤è¯ç”¨æˆ·ä¸Šä¼ ç­–ç•¥å·²è®¾ç½®
- [ ] è®¤è¯ç”¨æˆ·æ›´æ–°ç­–ç•¥å·²è®¾ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] è®¤è¯ç”¨æˆ·åˆ é™¤ç­–ç•¥å·²è®¾ç½®ï¼ˆå¯é€‰ï¼‰

### âœ… ç”¨æˆ·æƒé™
- [ ] ç”¨æˆ·å·²ç™»å½•ï¼ˆç”¨äºä¸Šä¼ ï¼‰
- [ ] åŒ¿åç”¨æˆ·å¯ä»¥è¯»å–ï¼ˆç”¨äºæ˜¾ç¤ºå›¾ç‰‡ï¼‰
- [ ] APIå¯†é’¥é…ç½®æ­£ç¡®

### âœ… åº”ç”¨é…ç½®
- [ ] ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
- [ ] Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

---

## ğŸš€ éªŒè¯ä¿®å¤æ•ˆæœ

### 1. æ£€æŸ¥å­˜å‚¨æ¡¶
```sql
SELECT name, public FROM storage.buckets WHERE name = 'news-images';
```

### 2. æ£€æŸ¥ç­–ç•¥
```sql
SELECT name, command, roles FROM storage.policies WHERE bucket_id = 'news-images';
```

### 3. æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
1. è®¿é—®æ–°é—»ç®¡ç†é¡µé¢
2. ç‚¹å‡»"æ–°å¢æ–°é—»"
3. ä¸Šä¼ ä¸€å¼ æµ‹è¯•å›¾ç‰‡
4. æ£€æŸ¥æ˜¯å¦æˆåŠŸå¹¶è¿”å›å…¬å…±URL

### 4. éªŒè¯å›¾ç‰‡è®¿é—®
1. è·å–ä¸Šä¼ çš„å›¾ç‰‡URL
2. åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€URL
3. ç¡®è®¤å›¾ç‰‡å¯ä»¥æ­£å¸¸æ˜¾ç¤º

---

## ğŸ†˜ å¦‚æœä»ç„¶æ— æ³•è§£å†³

### 1. æ£€æŸ¥Supabaseé¡¹ç›®è®¾ç½®
- ç¡®è®¤é¡¹ç›®æœªå¯ç”¨RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰é™åˆ¶å­˜å‚¨è®¿é—®
- æ£€æŸ¥APIå¯†é’¥æƒé™

### 2. æ£€æŸ¥ç½‘ç»œå’Œé˜²ç«å¢™
- ç¡®è®¤æµè§ˆå™¨å¯ä»¥è®¿é—®SupabaseæœåŠ¡
- æ£€æŸ¥æ˜¯å¦æœ‰CORSé”™è¯¯

### 3. è”ç³»æ”¯æŒ
å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ï¼š
- é”™è¯¯ä¿¡æ¯æˆªå›¾
- æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—
- Supabaseé¡¹ç›®IDï¼ˆå¯è„±æ•ï¼‰
- æ‰§è¡Œçš„SQLè¯­å¥

---

## ğŸ“ è·å–å¸®åŠ©

- ğŸ’» **æ§åˆ¶å°è°ƒè¯•**: `debugNewsStorage()`
- ğŸ“„ **è¯¦ç»†æ—¥å¿—**: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°
- ğŸ”§ **SQLä¿®å¤**: æ‰§è¡Œ `fix-storage-access.sql`
- ğŸ“– **å®˜æ–¹æ–‡æ¡£**: https://supabase.com/docs/guides/storage